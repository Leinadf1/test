<html>
  <head>
    <meta charset="ISO-8859-1"> 
    <!-- Shaka Player compiled library: -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.11.11/shaka-player.ui.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.11.11/controls.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <title>Test Multi-Stream</title>
    <style>
        body { background-color: #262626; color: white; font-family: "Roboto", sans-serif; }
        .center { margin: auto; width: 50%; text-align: center; }
        video { width: 100%; height: 100%; }
        select { margin-bottom: 20px; padding: 5px; font-size: 16px; }
    </style>
  </head>
  <body>
    <div class="center">
      <h2>Seleziona Stream</h2>
      <select id="streamSelect">
        <option value="dazn">DAZN</option>
        <option value="skysport">Sky Sport Calcio</option>
      </select>
    </div>

    <div data-shaka-player-container style="max-width:40em" data-shaka-player-cast-receiver-id="07AEE832" class="center">
      <video autoplay data-shaka-player id="video"></video>
    </div>

    <script>
      const streams = {
        dazn: {
          manifest: 'https://dcs-ak-livedazn.akamaized.net/dash/dazn-linear-206/stream.mpd?p=web',
          clearKeys: { '6164a0abaa7c53c6875fa1e7fe0bb463': '271510d3e1259571dcc568a232e397eb' },
          userAgent: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/141.0.0.0 Safari/537.36'
        },
        skysport: {
          manifest: 'https://g004-lin-it-cmaf-prd-cf.pcdn07.cssott02.com/v~1-0-0_e~1762228822_f~0_g~1_s~215c05ae-8561-4e9f-b89d-7ba574ae9eb9_u~01196498e2294fc9bc543d7248d8266eddbbc335693f0d7d35f3a53b31177cf6_k~A_l~60_x~4a2643216a4823163d3dbbbe3fa4331c/nowitlin1/Content/CMAF_CTR_H1/Live/channel(skysportcalcio)/master_2hr-all.mpd',
          clearKeys: { '111859b69daaf37a2893c3e4d5db7560': '9954a25e97fc84e6d80bbd35d469d381' },
          userAgent: 'Media3Player/6.7.200 (Linux;Android 9) AndroidXMedia3-Sky-CVSDK/1.5.1 [kara, AFTKA, Amazon, 28]'
        }
      };

      async function init() {
        const video = document.getElementById('video');
        const ui = video['ui'];
        const controls = ui.getControls();
        const player = controls.getPlayer();

        window.player = player;
        window.ui = ui;

        player.addEventListener('error', e => console.error('Player error:', e.detail));
        controls.addEventListener('error', e => console.error('UI error:', e.detail));

        // Carica stream iniziale DAZN
        await loadStream('dazn');

        // Cambia stream quando si seleziona dal menu
        document.getElementById('streamSelect').addEventListener('change', async function() {
          const selected = this.value;
          await loadStream(selected);
        });

        async function loadStream(key) {
          const stream = streams[key];
          player.getNetworkingEngine().clearAllRequestFilters();
          player.getNetworkingEngine().registerRequestFilter((type, request) => {
            if (type === shaka.net.NetworkingEngine.RequestType.MANIFEST ||
                type === shaka.net.NetworkingEngine.RequestType.SEGMENT) {
              request.headers['User-Agent'] = stream.userAgent;
              if(key==='dazn'){
                request.headers['dazn-token'] = 'st=1762080275~exp=1762166675~acl=/*~id=8160f8ea0080~data=country=it#asn=3269#path=1s,2d#hashp=7146d3dea70044f8d191494cbaf9b170539059551a801458f7e9193ddef7835d#hashua=8d3a4310782ed11654708481a971289b2b41320c78fe2ca10c0be5d9c3af9b5b~hmac=8b1f4484c7bcdb8db4a2a8bf66e0837d3277118b37ae082e863086e735ac398b';
              }
            }
          });

          player.configure({ drm: { clearKeys: stream.clearKeys } });

          try {
            await player.load(stream.manifest);
            console.log(`${key} stream loaded successfully!`);
          } catch (e) {
            console.error(`Error loading ${key}:`, e);
          }
        }
      }

      document.addEventListener('shaka-ui-loaded', init);
      document.addEventListener('shaka-ui-load-failed', () => console.error('Unable to load Shaka UI'));
    </script>
  </body>
</html>
